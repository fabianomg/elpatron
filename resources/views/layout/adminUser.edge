@if(auth.user.level == 2)
<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta charset="utf-8" />
    <title>El patron</title>
    <meta name="description" content="top menu &amp; navigation" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- bootstrap & fontawesome -->
    <link rel="stylesheet" href="assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="assets/font-awesome/4.5.0/css/font-awesome.min.css" />
    <!-- page specific plugin styles -->
    <!-- text fonts -->
    <link rel="stylesheet" href="assets/css/fonts.googleapis.com.css" />
    <!-- page specific plugin styles -->
    <link rel="stylesheet" href="assets/css/jquery-ui.min.css" />
    <!-- ace styles -->
    <link rel="stylesheet" href="assets/css/ace.min.css" class="ace-main-stylesheet" id="main-ace-style" />
    <!--[if lte IE 9]>
      <link rel="stylesheet" href="assets/css/ace-part2.min.css" class="ace-main-stylesheet" />
      <![endif]-->
    <link rel="stylesheet" href="assets/css/ace-skins.min.css" />
    <link rel="stylesheet" href="assets/css/ace-rtl.min.css" />
    <!--[if lte IE 9]>
      <link rel="stylesheet" href="assets/css/ace-ie.min.css" />
      <![endif]-->
    <!-- inline styles related to this page -->
    <!-- ace settings handler -->
    <script src="assets/js/ace-extra.min.js"></script>
    <!-- HTML5shiv and Respond.js for IE8 to support HTML5 elements and media queries -->
    <!--[if lte IE 8]>
      <script src="assets/js/html5shiv.min.js"></script>
      <script src="assets/js/respond.min.js"></script>
      <![endif]-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-polyfill/7.4.4/polyfill.min.js"></script>
    <script src="https://unpkg.com/@adonisjs/websocket-client"></script>
</head>

<body class="no-skin">

    <div id="navbar" class="navbar navbar-default navbar-collapse h-navbar ace-save-state">
        <div class="navbar-container ace-save-state justify-content-between" id="navbar-container">
            <div class="navbar-header pull-left">
                <a href="/" class="navbar-brand">
                    <small>
                        El Patron
                    </small>
                </a>
                <button class=" pull-right navbar-toggle navbar-toggle-img collapsed" type="button"
                    data-toggle="collapse" data-target=".navbar-buttons">
            </div>

            <div class=" navbar-buttons navbar-header pull-right navbar">

                <ul class="nav ace-nav">

                    <li>
                        <a href="/logout">
                            <i class="ace-icon fa fa-power-off"></i> Sair
                        </a>

                    </li>
                </ul>

            </div>
        </div>
    </div>
    <!-- /.navbar-container -->
    </div>

    <div class="main-container ace-save-state" id="main-container">


        <center>
            <div class="row" style="margin-top:20px;">
                <div class="col-md-12 justify-content-center">
                    <span class="label label-xlg label-info  arrowed-right">
                        Você tem: <span class="badge badge-success" id="creditos">{{auth.user.balance}}</span> Créditos
                    </span>
                    <span style="margin-top:10px;" class="label label-xlg label-info arrowed-in ">Seus
                        créditos expiram em: <span class="badge badge-success">{{auth.user.end}}</span>
                    </span>
                </div>
            </div>
        </center>


    </div>
    
    <div class="row justify-content-center">
        <center>
        <div id="msg" {{msg.h}} class=" col-md-8 col-md-offset-2 alert alert-{{msg.c}}">
           
            <button type="button" class="close" data-dismiss="alert">
                <i class="ace-icon fa fa-times"></i>
            </button>
            <strong id="emsgdestaque">{{msg.md}}</strong>
            {{msg.m}}
            <br>
        </div>
        @include('includes.notification')
    </center>
    </div>
    
    <div class="main-content" style="background-color:#868e96;">
        <div class="main-content-inner">
            <div class="page-content">
                <div class="row">
                    <div class="col-xs-12">
                        <!-- PAGE CONTENT BEGINS -->
                        <div class="row">
                            <div class="space-6"></div>
                            <div class="col-sm-3 infobox-container">
                                <div class="col-md-2">
                                    <div class="text-center">
                                        <img style="width: 200px; height: auto;" src="assets/images/logotipo.png"
                                            class="rounded" alt="El Patron">
                                    </div>
                                </div>
                            </div>


                            <form id="start" action="{{ route('start') }}" method="post">
                                {{ csrfField() }}

                                <div style="padding-left: 100px;"
                                    class="col-md-4 col-md-offset-1 text-center infobox-container">
                                    <textarea style="max-width: 266px;min-height: 300px;resize: none;" required
                                        form="start" style="resize: none;text-align: center; height: 240px;"
                                        placeholder="000000000000000|00|0000|000" id="txtstart" name="txtstart"
                                        class="autosize-transition form-control"
                                        style="overflow: hidden; overflow-wrap: break-word; resize: horizontal; height: 152px;"></textarea>
                                </div>

                            </form>
                            <div class="vspace-12-sm"></div>
                            <div class="col-sm-3">
                                <div class="widget-box transparent">
                                    <div class="widget-header widget-header-flat">
                                        <h3 class="widget-title lighter">

                                            <i id="cstatus" class="ace-icon fa fa-star orange "></i>
                                            Status <span id="status"
                                                class="label label-success arrowed arrowed-right">Aguardando...</span>
                                        </h3>
                                        <div class="widget-toolbar">
                                            <a href="#" data-action="collapse">
                                                <i class="ace-icon fa fa-chevron-up"></i>
                                            </a>
                                        </div>
                                    </div>
                                    <div class="widget-body">
                                        <div class="widget-main no-padding">
                                            <div class="table-responsive-md">
                                                <table class="table table-bordered table-responsiv">
                                                    <tbody>
                                                        <tr>
                                                            <td class="display-4">Aprovadas</td>
                                                            <td class="hidden-380">
                                                                <span id="aprovadas"
                                                                    class="label label-success arrowed-right arrowed-in">0</span>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>Reprovadas</td>
                                                            <td class="hidden-380">
                                                                <span id="reprovadas"
                                                                    class="label label-danger arrowed-right arrowed-in">0</span>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>Testadas</td>
                                                            <td class="hidden-380">
                                                                <span id="testadas"
                                                                    class="label label-warning arrowed-right arrowed-in">0</span>
                                                            </td>
                                                        </tr>

                                                        <tr>
                                                            <td>Total de Carregadas</td>
                                                            <td class="hidden-380">
                                                                <span id="carregadas"
                                                                    class="label label-info arrowed-right arrowed-in">0</span>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <!-- /.widget-main -->
                                    </div>
                                    <!-- /.widget-body -->
                                </div>
                                <!-- /.widget-box -->
                            </div>
                            <!-- /.col -->
                        </div>
                        <!-- /.row -->
                        <div class="row text-center">
                            <span class="d-inline-block" tabindex="0" data-toggle="tooltip" title="{{msg.t}}">
                                <button onclick="salvarForm();" {{msg.b}} id="start" type="button"
                                    style="margin-top:10px;" class="btn btn-success">
                                    <i class="ace-icon fa fa-play align-top bigger-125"></i> Começar
                                </button>
                            </span>
                            <!-- inicio button parar-->
                            <span class="d-inline-block" tabindex="0" data-toggle="tooltip"
                                title="inicie uma verificação para poder ativar o botão">
                                <button type="button" id="stop" disabled="true" style="margin-top:10px;"
                                    class="btn btn-danger">
                                    <i class="ace-icon fa fa-stop align-top bigger-125"></i> Parar
                                </button>
                            </span>

                            <!-- fim button parar-->
                            <span class="d-inline-block" tabindex="0" data-toggle="tooltip"
                                title="voltar página anterior">
                                <a style="margin-top:10px;" href="javascript: history.go(-1)" type="button"
                                    class="btn btn-primary">
                                    <i class="ace-icon fa fa-home  align-top bigger-125 icon-on-right"></i> Home
                                </a>
                            </span>
                        </div>
                        <div class="hr hr32 hr-dotted"></div>

                        <div class="row">
                            <div class="col-lg-8 col-lg-offset-2">
                                <div class="widget-box widget-color-green">
                                    <div class="widget-header">
                                        <center>
                                            <h4 class="widget-title lighter smaller">Aprovadas<span
                                                    id="apro"></span></span></h4>
                                        </center>
                                    </div>
                                    <div class="widget-body">
                                        <div id="resultAprovadas" class="widget-main padding-8">

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- /.row -->
                        <div class="row">
                            <div class="col-lg-8 col-lg-offset-2 ">
                                <div class="widget-box widget-color-red">
                                    <div class="widget-header">
                                        <center>
                                            <h4 class="widget-title lighter smaller  text-center">Reprovadas<span
                                                    id="repro"></span></h4>
                                        </center>
                                    </div>
                                    <div class="widget-body">
                                        <div class="widget-main padding-10" id="resultReprovadas">

                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div id="dialog-confirm" class="hide">
                            <div class="alert alert-info bigger-110">
                                todos os dados dos cartões seram excluídos permanentemente e não poderão ser
                                recuperados.
                            </div>

                            <div class="space-6"></div>

                            <p class="bigger-110 bolder center grey">
                                <i class="ace-icon fa fa-hand-o-right blue bigger-120"></i>
                                Deseja Proseguir?
                            </p>
                        </div><!-- #dialog-confirm -->
                        <div id="dialog-message" class="hide">
                            <p id="cex_te_msg">

                            </p>

                            <div class="hr hr-12 hr-double"></div>

                            <p id="cex_te_pro">

                            </p>
                        </div><!-- #dialog-message -->
                        <!-- /.row -->
                        <!-- PAGE CONTENT ENDS -->
                    </div>
                    <!-- /.col -->
                </div>
                <!-- /.row -->
            </div>
            <!-- /.page-content -->

        </div>
    </div>
    <!-- /.main-content -->
    <div class="footer">
        <div class="footer-inner">
            <div class="footer-content">
                <span class="bigger-120">
                    Elpatron &copy; 2020
                </span>
            </div>
        </div>
    </div>
    <a href="#" id="btn-scroll-up" class="btn-scroll-up btn btn-sm btn-inverse">
        <i class="ace-icon fa fa-angle-double-up icon-only bigger-110"></i>
    </a>
    </div>
    <!-- /.main-container -->
    <!-- basic scripts -->
    <!--[if !IE]> -->
    <script src="assets/js/jquery-2.1.4.min.js"></script>
    <!-- <![endif]-->
    <!--[if IE]>
      <script src="assets/js/jquery-1.11.3.min.js"></script>
      <![endif]-->
    <script type="text/javascript">
        if ('ontouchstart' in document.documentElement) document.write("<script src='assets/js/jquery.mobile.custom.min.js'>" + "<" + "/script>");
    </script>
    <script src="assets/js/bootstrap.min.js"></script>
    <!-- page specific plugin scripts -->
    <!-- ace scripts -->
    <script src="assets/js/jquery-ui.min.js"></script>
    <script src="assets/js/jquery.ui.touch-punch.min.js"></script>
    <script src="assets/js/ace-elements.min.js"></script>
    <script src="assets/js/ace.min.js"></script>
    <script src="assets/js/jquery.easypiechart.min.js"></script>

    <!-- inline scripts related to this page -->
    <script type="text/javascript">
        $('body').scrollspy({
            target: '#listreprovados'
        })
        jQuery(function ($) {
            $('.easy-pie-chart.percentage').each(function () {
                var $box = $(this).closest('.infobox');
                var barColor = $(this).data('color') || (!$box.hasClass('infobox-dark') ? $box.css('color') : 'rgba(255,255,255,0.95)');
                var trackColor = barColor == 'rgba(255,255,255,0.95)' ? 'rgba(255,255,255,0.25)' : '#E2E2E2';
                var size = parseInt($(this).data('size')) || 100;
                $(this).easyPieChart({
                    barColor: barColor,
                    trackColor: trackColor,
                    scaleColor: false,
                    lineCap: 'butt',
                    lineWidth: parseInt(size / 10),
                    animate: ace.vars['old_ie'] ? false : 1000,
                    size: size
                });
            })
            var $sidebar = $('.sidebar').eq(0);
            if (!$sidebar.hasClass('h-sidebar')) return;

            $(document).on('settings.ace.top_menu', function (ev, event_name, fixed) {
                if (event_name !== 'sidebar_fixed') return;

                var sidebar = $sidebar.get(0);
                var $window = $(window);

                //return if sidebar is not fixed or in mobile view mode
                var sidebar_vars = $sidebar.ace_sidebar('vars');
                if (!fixed || (sidebar_vars['mobile_view'] || sidebar_vars['collapsible'])) {
                    $sidebar.removeClass('lower-highlight');
                    //restore original, default marginTop
                    sidebar.style.marginTop = '';

                    $window.off('scroll.ace.top_menu')
                    return;
                }

                var done = false;
                $window.on('scroll.ace.top_menu', function (e) {

                    var scroll = $window.scrollTop();
                    scroll = parseInt(scroll / 4); //move the menu up 1px for every 4px of document scrolling
                    if (scroll > 17) scroll = 17;

                    if (scroll > 16) {
                        if (!done) {
                            $sidebar.addClass('lower-highlight');
                            done = true;
                        }
                    } else {
                        if (done) {
                            $sidebar.removeClass('lower-highlight');
                            done = false;
                        }
                    }

                    sidebar.style['marginTop'] = (17 - scroll) + 'px';
                }).triggerHandler('scroll.ace.top_menu');

            }).triggerHandler('settings.ace.top_menu', ['sidebar_fixed', $sidebar.hasClass('sidebar-fixed')]);

            $(window).on('resize.ace.top_menu', function () {
                $(document).triggerHandler('settings.ace.top_menu', ['sidebar_fixed', $sidebar.hasClass('sidebar-fixed')]);
            });

        });
    </script>
    <script>
        function salvarForm() {

            $('#start').submit(); //usando jquery
        }
        function parar() {
            $.ajax({
                type: "GET",
                url: window.location + 'stop',
                data: '',
                dataType: ''
            });

        }
    </script>
    <script>
        let id = {{ auth.user.id }};
        let url;
        let protrocol = window.location.protocol;
        if (protrocol == 'http:') {
            url = 'ws://' + window.location.host;
        } else {
            url = 'wss://' + window.location.host
        }

        const ws = adonis.Ws(url).connect();
        let isConnected = false

        ws.on('open', () => {
            isConnected = true
        })

        ws.on('close', () => {

            isConnected = false
            // alert(' Websocket Desconectado, por favor reinicie a página')
        })
        // ###########creditos################
        const creditos = ws.subscribe('status:cred' + id)

        creditos.on('message', (creditos) => {

            $('#creditos').text(creditos)
        });
        // ###########carregadas################
        const status = ws.subscribe('status:s' + id)

        status.on('message', (s) => {

            if (s.s == 'start') {
                $('#cstatus').addClass('fa-spin')
            }
            if (s.s == 'end') {
                $('#cstatus').removeClass('fa-spin')
            }

            $('#status').text(s.msg)
        });
        // ###########carregadas################
        const carregadas = ws.subscribe('status:c' + id)

        carregadas.on('message', (c) => {

            $('#carregadas').text(c)
        });
        // ###########testadas################
        const testadas = ws.subscribe('status:t' + id)

        testadas.on('message', (t) => {
            if (t == '') {
                $('#testadas').text(0)

            } else {
                $('#testadas').text(t)
            }

        });
        // ###########reprovadas################
        const reprovadas = ws.subscribe('status:r' + id)

        reprovadas.on('message', (r) => {

            if (r.cont == 0) {
                console.log(r.cont)
                $('#resultAprovadas .remov').remove()
            } else {
                $('#resultReprovadas').append(r.msg)
            }

            $('#reprovadas').text(r.cont)
            $('#repro').text(' #' + r.cont + '#')
        });
        // ###########button start################
        const start = ws.subscribe('status:st' + id)
        start.on('message', (st) => {
            const buttons = $("button[id='start']");
            buttons.prop('disabled', st)
            console.log(st)

        });
        // ###########button stop################
        const stop = ws.subscribe('status:stop' + id)
        stop.on('message', (stop) => {
            const buttons2 = $("button[id='stop']");
            buttons2.prop('disabled', stop)

        });

        // ###########aprovadas################
        const aprovadas = ws.subscribe('status:a' + id)

        aprovadas.on('message', (a) => {

            if (a.cont == 0) {
                $('#resultAprovadas .remov').remove()
            } else {
                $('#resultAprovadas').append(a.msg)
            }

            $('#aprovadas').text(a.cont)

            $('#apro').text(' #' + a.cont + '#')
        });
        // ###########mensagem################
        const mensagem = ws.subscribe('status:msg' + id)

        mensagem.on('message', (a) => {
            $('#resultAprovadas').append(a.msg)
            $('#aprovadas').text(a.cont)
        });

        //#######expired##############

        const credexpired = ws.subscribe('status:cex_te' + id)

        credexpired.on('message', (tx) => {
            $('#cex_te_msg').text(tx.msg);
            $('#cex_te_pro').text(tx.pro);

            var dialog = $("#dialog-message").removeClass('hide').dialog({
                modal: true,
                title_html: true,
                buttons: [

                    {
                        text: "OK",
                        "class": "btn btn-primary btn-minier",
                        click: function () {
                            //location.reload();
                            $(this).dialog("close");
                        }
                    }
                ]
            });
        });



        $("#stop").on('click', function (e) {
            e.preventDefault();

            $("#dialog-confirm").removeClass('hide');
            $("#dialog-confirm").dialog({
                resizable: false,
                width: '320',
                modal: true,

                title_html: false,
                buttons: [
                    {
                        html: "<i class='ace-icon fa fa-trash-o bigger-110'></i>&nbsp; Parar Agora",
                        "class": "btn btn-danger btn-minier",
                        "onClick": "parar();",
                        click: function () {

                            $(this).dialog("close");
                        }
                    }
                    ,
                    {
                        html: "<i class='ace-icon fa fa-times bigger-110'></i>&nbsp; Cancelar",
                        "class": "btn btn-minier",
                        click: function () {
                            $(this).dialog("close");
                        }
                    }
                ]
            });
        });
    </script>
</body>

</html>
@else
<script type="text/javascript">
    window.location = '/logout'
</script>
@endif